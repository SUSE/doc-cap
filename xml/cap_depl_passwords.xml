<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter version="5.0" xml:id="cha.cap.manage-passwords"
  xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:xlink="http://www.w3.org/1999/xlink">
 <info>
  <title>Managing Passwords</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker></dm:bugtracker>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <para>
  The various components of &productname; authenticate to each using passwords
  that are automatically managed by the &cap; secrets-generator. The only
  passwords managed by the cluster administrator are passwords for human users,
  and service passwords set in the cluster's <filename>values.yaml</filename>
  configuration file (e.g. the example
  <filename>scf-config-values.yaml</filename> used in this guide).
 </para>
 <itemizedlist>
  <listitem>
   <para>
    The cluster administrator password is initially defined in the deployment's
    <filename>values.yaml</filename> file with
    <literal>CLUSTER_ADMIN_PASSWORD</literal>
   </para>
  </listitem>
  <listitem>
   <para>
    The Stratos Web UI provides a form for users, including the administrator,
    to change their own passwords
   </para>
  </listitem>
  <listitem>
   <para>
    User logins are created (and removed) with the Cloud Foundry Client, cf CLI
   </para>
  </listitem>
  <listitem>
   <para>
    Service passwords, such as the UAA_ADMIN_CLIENT_SECRET, are first created
    in the cluster's <filename>values.yaml</filename> configuration file, and
    can be changed after deployment with the <command>helm upgrade</command>
    command.
   </para>
  </listitem>
 </itemizedlist>
 <sect1 xml:id="sec.cap.passwords-cli">
  <title>Password Management with the Cloud Foundry Client</title>

  <para>
   The administrator cannot change other users' passwords. Only users may
   change their own passwords, and password changes require the current
   password:
  </para>

<screen>
&prompt.user;cf passwd
Current Password>
New Password> 
Verify Password> 
Changing password...
OK
Please log in again
</screen>
 </sect1>
 <sect1 xml:id="sec.cap.passwords-stratos">
  <title>Changing User Passwords with Stratos</title>

  <para>
   The Stratos Web UI provides a form for changing passwords on your profile
   page. Click the overflow menu button on the top right to access your
   profile, then click the edit button on your profile page. You can manage
   your password and username on this page.
  </para>

  <figure xml:id="fig.cap.stratos-profile.png">
   <title>Stratos Profile Page</title>
   <mediaobject>
    <imageobject>
     <imagedata fileref="stratos-profile.png" format="PNG" width="75%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <figure xml:id="fig.cap.stratos-edit-profile">
   <title>Stratos Edit Profile Page</title>
   <mediaobject>
    <imageobject>
     <imagedata fileref="stratos-edit-profile.png" format="PNG" width="75%"/>
    </imageobject>
   </mediaobject>
  </figure>
 </sect1>
 <sect1 xml:id="sec.cap.passwords-config">
  <title>Changing Passwords Set in values.yaml</title>

  <para>
   Service passwords created in the deployment's
   <filename>values.yaml</filename> file can be changed after deployment with
   the <command>helm upgrade</command> command, like this example for the
   UAA_ADMIN_CLIENT_SECRET. First change the password in the configuration
   file, then apply the change. The scf and stratos namespaces depend on the UAA 
   password and TLS certifications, and must be updated as well:
  </para>

<screen>
&prompt.user;helm upgrade --recreate-pods <replaceable>susecf-uaa</replaceable> suse/uaa \
 --values scf-config-values.yaml

&prompt.user;SECRET=$(kubectl get pods --namespace uaa \
 -o jsonpath='{.items[*].spec.containers[?(.name=="uaa")].env[?(.name=="INTERNAL_CA_CERT")].valueFrom.secretKeyRef.name}')

&prompt.user;CA_CERT="$(kubectl get secret $SECRET --namespace uaa \
 -o jsonpath="{.data['internal-ca-cert']}" | base64 --decode -)"

&prompt.user;helm upgrade --recreate-pods <replaceable>susecf-scf</replaceable> suse/cf \
 --values scf-config-values.yaml --set "secrets.UAA_CA_CERT=${CA_CERT}"

&prompt.user;helm upgrade --recreate-pods <replaceable>susecf-console</replaceable> suse/console \
 --values scf-config-values.yaml</screen>
 </sect1>
</chapter>
